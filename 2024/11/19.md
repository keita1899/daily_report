# 11/19

## 取り組んだこと

- Amazon Web Services 基礎からのネットワーク＆サーバー構築
  - 1
  - 2
  - 3
  - 4

## 学んだこと

### Amazon Web Services 基礎からのネットワーク＆サーバー構築

#### 1 章 システム構築をインフラから始めるには

- ネットワークやサーバーの知識を身につければ障害が発生した時の原因を切り分けられ、システム全体での対応ができる
- システム全体を設計するときは、どんなサーバーが必要か考え、サーバーを構築し、構築したサーバーをネットワークで接続する
- サーバーとは、Linux などのサーバー用の OS をインストールしたコンピュータにすぎない
- サーバーにどのようなソフトウェアをインストールするかでサーバーの役割が決まる
- サーバー構築に必要な知識
  - サーバー OS のインストール方法
  - 各ソフトウェアのインストールや設定方法
- サーバーはネットワークに接続しないと通信できない
- インターネットと接続可能なネットワークでは TCP/IP というプロトコルを使っている
- TCP/IP ではそれぞれのサーバーに IP アドレスを振る
- 各サーバーでルーターにデータが流れるように構成する必要がある
- ドメイン名を使うために DNS サーバーの設定も必要
- ネットワーク構築に必要な知識
  - IP アドレスに関する知識
  - DNS サーバーに関する知識
- 各種ネットワーク関連のコマンド
  - ping
  - traceroute
  - telnet
  - nslookup
  - dig
- 構築するネットワークは外部に公開するパブリックサブネットと、公開しないプライベートサブネットに分かれる
- DB サーバーがインターネットにアクセスできないとソフトウェアをインストールしたりアップデートすることができなくなるので、片方向だけの接続を許すために NAT を導入する
- ネットワークやサーバーを実際に構築するには回線、各種サーバー、ハブ、ルーターなどが必要になる
- それぞれの地域に存在するデータセンター群のことをリージョンという
- リージョンの中で耐障害性を高めるためにアベイラビリティゾーンに分かれている
- AWS でネットワークやサーバーを構築するにはどのリージョンの、どのアベイラビリティゾーンに置くのかを決める必要がある
- 通常、大きな障害に備えて複数のアベイラビリティゾーンに EC2 を配置することが推奨されている
- AWS でネットワークを作るには VPC を使う
- VPC を作る時にはどのような IP アドレスの範囲を使うかを指定し、いくつかのネットワーク（サブネット）に分割する
- サブネットにサーバーを配置する
- AWS では EC2 でサーバーを作り、起動した各サーバーの個体をインスタンスという
- インスタンスを作る時には CPU のスペックやディスク容量を決める

- 本書の流れ
  1. システムの土台となるネットワークを設計して構築する
  2. Amazon EC2 でサーバーを構築する
  3. 構築したサーバーに Apache をインストールして Web サーバーとして構成する
  4. Web サーバーの HTTP の動きを確認する
  5. プライベートサブネットを作り、DB サーバーをインストールして DB サーバーとして構築する
  6. プライベートサブネットからインターネットに接続できるように NAT を構築する
  7. DB サーバーに MariaDB をインストールした後、Web サーバーに WordPress をインストールしてブログシステムを完成させる
  8. TCP/IP の通信を理解する

#### 2 章 ネットワークを構築する

- IP アドレスはネットワーク上で互いに重複しない唯一無二の番号で、32 ビットで構成される
- インターネットで使われる IP アドレスはパブリック IP アドレスといい、ICANN という団体が管理しており、勝手に設定できない
- パブリック IP アドレスと反対にインターネットで使われない IP アドレスをプライベート IP アドレスという
- IP アドレスの範囲は、ネットワーク機器を接続するのに十分な数を確保する
- IP アドレスの範囲は自由に決めることはできず、2 の n 乗個で区切る必要がある
- よく使われる区切りが 256 個（8 ビット分）と 65536 個（16 ビット分）
- IP アドレスは前半の部分をネットワーク部、後半をホスト部という
- ネットワーク部は同じネットワークなら同じ値になり、ホスト部は割り当てたいネットワーク機器に対する連番になる
- IP アドレスの範囲を表すときは CIDR 表記またはサブネットマスクのどちらかを使う
- CIDR 表記はネットワーク部の同じ部分をプレフィックスで表す表記
- サブネットマスクはプレフィックスのビット数だけ 2 進数の 1 を並べ、残りを 0 とする表記
- 表記の違い
  - 192.168.1.0 ~ 192.168.1.255
  - 192.168.1.0/24
  - 192.168.1.0/255.255.255.0
- AWS マネジメントコンソールで VPC を作る作業はルーターやハブなどを用意する作業
- VPC を作る手順
  1. マネジメントコンソールで VPC を開く
  2. リージョンを設定
  3. VPC 領域を作成する
  4. パブリックサブネットを作る
  5. CIDR ブロックを設定する
  6. インターネットゲートウェイを作る
  7. インターネットゲートウェイを VPC に結びつける
  8. デフォルトゲートウェイをインターネットゲートウェイに設定する
- 実際のネットワークでは CIDR ブロックをさらに分割して使う（サブネット）
- サブネットに分けることで、障害対策になる、別のネットワークの設定ができるメリットがある
- サブネットをインターネットに接続するにはインターネットゲートウェイを使う
- ネットワークにデータを流すにはルーティング情報という設定が必要であり、ルーティングテーブルで行う
- TCP/IP ではデータはパケットという細切れの単位で送受信される
- TCP/IP では、ルーターがパケットに含まれる宛先 IP アドレスを見ながらパケットを転送して目的地まで届ける
- 宛先 IP アドレスの値がいくつのときにはどのネットワークに流すべきかを設定するのがルートテーブル
- ルートテーブルは宛先アドレス、流すべきネットワーク（ターゲット）の入り口となるルーターという書式になっている
- VPC では意識することはないが、サブネットやインターネットゲートウェイの間にルーターの役割をするソフトウェアが動作している
- VPC を作った直後にはデフォルトのルートテーブルが作られている
- まとめ
  - プライベートネットワーク空間である VPC とそこに関連づけられたインターネットゲートウェイがある
  - VPC の中にパブリックサブネットがあり、パブリックルートテーブルと関連づけられている
  - ルートテーブルには同 VPC 領域内の通信は内部でルーティング、それ以外の通信はインターネットゲートウェイに転送するように設定されている

#### 3 章 サーバーを構築する

- インスタンスには VPC 内で通信するためのプライベート IP アドレスと、インターネットで通信するためのパブリック IP アドレスの 2 つを持つ
- インスタンスの作成手順
  1. マネジメントコンソールから EC2 タブを開く
  2. リージョンの選択
  3. インスタンスの作成
  4. AMI（イメージファイル）を選択
  5. インスタンスタイプ（仮想マシンのスペック）を選択する
  6. インスタンスを配置するサブネットを選択する
  7. インスタンスにパブリック IP アドレスを付与
  8. インスタンスにプライベート IP アドレスを付与
  9. 仮想ハードディスク（ストレージ）を設定する
  10. インスタンスに名前をつける
  11. インスタンスに対してセキュリティグループを設定する
  12. インスタンスを起動する
  13. キーペアを作成する
  14. ポートに合わせてセキュリティグループを設定する
- AMI は OS がインストールされて初期アカウントの設定までが済んだもの
- Elastic IP という機能を使うと IP アドレスを固定化できる
- CIDR ブロックの先頭（ネットワークアドレス）と末尾（ブロードキャストアドレス）はサーバーなどのホストに設定できない
- ネットワークアドレスはネットワーク全体を示すアドレス
- ブロードキャストアドレスは全てのホストを示すアドレス
- デフォルトのセキュリティグループでは SSH でどこからでも接続できるようになっているが、推奨はされていない
- キーペアはインスタンスにログインする時に必要な鍵
- インスタンスを利用していないときは停止すると課金対象から外れる
- インスタンスが使っているストレージはインスタンスを停止しても課金の対象になるので注意
- SSH 接続には SSH クライアントソフトが必要（Mac はターミナルから起動できる）
- `ssh -i キーペアファイル 接続するユーザー名@パブリックIPアドレス`で SSH 接続を行う
- インターネットではルーティングプロトコルといって、ルーター同士が通信してルートテーブルの情報を必要に応じて自動的に更新するようになっている
- ルーティングプロトコルは EGP と IGP という 2 つの種類がある
- EGP はどのネットワークの先に、どのネットワークが接続されているのかをやりとりする
- IGP は EGP の内部のルーター同士でルートテーブルの情報を詳細なやり取りをする
- ルーティングプロトコルの仕組みによって、相手の IP アドレスさえわかればパケットを届けることができる
- sshd という SSH 接続を受け入れるプログラムによって SSH 接続が可能になる
- 他のコンピュータとデータを送受信するためのデータの出入り口であるポートによって、1 つの IP アドレスで複数のアプリと通信ができる
- ポートには相手にデータが届いたことを保証する TCP と、確認せずに送信する UDP の 2 種類ある
- `lsof`でポートを調べることができる
- `LISTEN`が他のコンピュータからの待受をしているポートで、`ESTABLISHED`が通信中のポート
- 127.0.0.1 はループバックアドレスと呼ばれ、自分自身を示す IP アドレス
- ウェルノウンポートによって代表的なアプリのポート番号はあらかじめ決められている
- ポート番号はサーバー側だけでなくクライアント側にもあり、未使用のランダムなポート番号が一時的に使われる（エフェメラルポート）
- ファイアウォールは通して良いデータだけを通すセキュリティ対策
- ファイアウォールの簡単な構造のものがパケットフィルタリングで、流れるパケットを見て通過の可否を決める仕組み
- パケットフィルタリングはルーターやサーバー、専用のファイアウォール機器が行うが、AWS ではインスタンスに構成するセキュリティグループが担当する
- セキュリティグループには外からインスタンスに接続する向きであるインバウンドと、インスタンスから外側に出ていく向きであるアウトバウンドの 2 つある
- まとめ
  - パブリックサブネットの中に 1 台のインスタンスを作る
  - 作成したインスタンスの中にパブリックとプライベート IP アドレスを設定
  - インスタンスをリモートで操作するために Tera Term（Windows） や SSH 接続する
  - ルーティング情報のやりとり、ポート、パケットフィルタリングとセキュリティグループについて学んだ

#### 4 章 Web サーバーソフトをインストールする

- Web サーバーソフトをインストールするとブラウザから要求を受け取ってサーバー乗のコンテンツを返したりアプリを実行したりできるようになる
- Apache をインストールする手順
  1. インスタンスにログインする
  2. `yum` コマンドで Apache をインストールする
  3. `systemctl` コマンドで Apache を起動する
  4. サーバーを起動した時に Apache が自動で起動するように構成する
- `ps`で実行中のプロセスを確認する
- Apache はポート 80 番を使っており、これは HTTP のウェルノウンポート
- ブラウザから Web サーバーにアクセスするときはパブリック IP アドレスを指定する
- ファイアウォールによってポート 80 番はブロックされているので、ポートを開ける必要がある
- Web サイトにアクセスする場合、一般的に IP アドレスを直接指定せずに、ドメイン名を使う
- ドメイン名は IP アドレス同様 ICANN が管理している
- ドメインを利用するときはレジストリは以下の指定事業者に申請する
- TCP/IP ではドメインは最終的に IP アドレスに変換して接続する、その仕組みは DNS という
- ドメインから対応する IP アドレスを引き出すことを名前解決という
- 名前解決はトップレベルドメインの DNS サーバーから始まり、そこから階層的に自分が担当する範囲の IP アドレスとドメインの変換の処理をして、管轄外の場合は他の DNS サーバーに問い合わせを転送する
- VPC には VPN 内の名前解決をするオプションがあり、有効にするとインスタンスに DNS 名が設定される
- Route53 を使うと独自ドメインを使える
- `nslookup`で DNS の名前解決を調査できる
- DNS は基本的に UDP で通信する
- サーバーは負荷分散ができるので、正引き（IP アドレス → ドメイン）と逆引き（ドメイン → IP アドレス）が対応しているとは限らない
-
- まとめ
  - サーバーに Apache をインストールして Web サーバーとして動作させる
  - ファイアウォールによって阻まれているポート 80 を通して通信可能にする
  - DNS 名を有効にする
  - DNS サーバーの動きを`nslookup`で調査する

## わからなかったこと

-

## 次やること

- Amazon Web Services 基礎からのネットワーク＆サーバー構築
  - 5
  - 6
  - 7
  - 8
  - 9

## 感想

ネットワークの設定がやること多くて難しい。
